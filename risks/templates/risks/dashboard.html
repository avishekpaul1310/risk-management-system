{% extends 'risks/base.html' %}
{% load static %}

{% block title %}Dashboard - Risk Management{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1>Risk Management Dashboard</h1>
        <p class="lead">Overview of all projects and risks in the system.</p>
    </div>
    <div class="col-auto">
        <a href="{% url 'export_risks_csv' %}" class="btn btn-success me-2">
            <i class="bi bi-file-earmark-spreadsheet"></i> Export CSV
        </a>
        <a href="{% url 'home' %}" class="btn btn-outline-secondary">
            <i class="bi bi-list"></i> View Projects
        </a>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <div class="d-flex justify-content-between">
            <h5 class="mb-0">Dashboard Filters</h5>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false">
                <i class="bi bi-funnel"></i> Toggle Filters
            </button>
        </div>
    </div>
    <div class="collapse" id="filterCollapse">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Project</label>
                    <select class="form-select" id="projectFilter">
                        <option value="all">All Projects</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Risk Level</label>
                    <select class="form-select" id="riskLevelFilter">
                        <option value="all">All Levels</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="all">All Statuses</option>
                        <option value="Open">Open</option>
                        <option value="Mitigated">Mitigated</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="categoryFilter">
                        <option value="all">All Categories</option>
                        {% for key in risks_by_category.keys %}
                        <option value="{{ key }}">{{ key }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="mt-2 text-end">
                <button class="btn btn-primary" id="applyFilters">Apply Filters</button>
                <button class="btn btn-outline-secondary" id="resetFilters">Reset</button>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary mb-3">
            <div class="card-body">
                <h5 class="card-title">Projects</h5>
                <p class="card-text display-4" id="project-count">{{ project_count }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info mb-3">
            <div class="card-body">
                <h5 class="card-title">Total Risks</h5>
                <p class="card-text display-4" id="risk-count">{{ risk_count }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning mb-3">
            <div class="card-body">
                <h5 class="card-title">Open Risks</h5>
                <p class="card-text display-4" id="open-risks">{{ open_risks }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success mb-3">
            <div class="card-body">
                <h5 class="card-title">Mitigated Risks</h5>
                <p class="card-text display-4" id="mitigated-risks">{{ mitigated_risks }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row mb-4">
    <!-- Risk Distribution Chart -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Risk Severity Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="riskSeverityChart" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Risk by Category Chart -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Risks by Category</h5>
            </div>
            <div class="card-body">
                <canvas id="riskCategoryChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- New Row with Risk Heat Map -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card mb-4">            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Risk Distribution Chart (Open Risks)</h5>
                <small class="text-light">Shows active risks by likelihood and impact combinations</small>
            </div>
            <div class="card-body" style="height: 400px; padding-bottom: 30px;">
                <canvas id="riskHeatMap" height="350"></canvas>
            </div>
            <div class="card-footer bg-light">
                <div class="row">
                    <div class="col text-center">
                        <span class="badge bg-success me-1">&nbsp;</span> Low Risk
                        <span class="badge bg-warning mx-1">&nbsp;</span> Medium Risk
                        <span class="badge bg-danger ms-1">&nbsp;</span> High Risk
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Risk Status Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="riskStatusChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- All Risks with Pagination -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">All Risks</h5>
                <div>
                    <input type="text" class="form-control form-control-sm d-inline-block" id="riskSearchInput" placeholder="Search risks..." style="width: 200px;">
                </div>
            </div>            <div class="card-body">
                <!-- Filter Controls -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="projectFilter" onchange="applyTableFilters()">
                            <option value="all">All Projects</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" id="riskLevelFilter" onchange="applyTableFilters()">
                            <option value="all">All Levels</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" id="statusFilter" onchange="applyTableFilters()">
                            <option value="all">All Status</option>
                            <option value="Open">Open</option>
                            <option value="Mitigated">Mitigated</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="categoryFilter" onchange="applyTableFilters()">
                            <option value="all">All Categories</option>
                            {% for category_name, count in risks_by_category.items %}
                            <option value="{{ category_name }}">{{ category_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearFilters()">Clear Filters</button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover" id="allRisksTable">
                        <thead>
                            <tr>
                                <th>Risk</th>
                                <th>Project</th>
                                <th>Category</th>
                                <th>Score</th>
                                <th>Likelihood</th>
                                <th>Impact</th>
                                <th>Owner</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for risk in all_risks_page %}
                            <tr class="{% if risk.risk_level == 'High' %}risk-score-high{% elif risk.risk_level == 'Medium' %}risk-score-medium{% else %}risk-score-low{% endif %}" 
                                data-project="{{ risk.project.id }}" 
                                data-level="{{ risk.risk_level }}" 
                                data-status="{{ risk.status }}" 
                                data-category="{{ risk.category.name }}">
                                <td>{{ risk.title }}</td>
                                <td>{{ risk.project.name }}</td>
                                <td>{{ risk.category.name|default:"None" }}</td>
                                <td><strong>{{ risk.risk_score }}</strong></td>
                                <td>{{ risk.get_likelihood_display }}</td>
                                <td>{{ risk.get_impact_display }}</td>
                                <td>{{ risk.owner }}</td>
                                <td>
                                    <a href="{% url 'risk_detail' risk.id %}" class="btn btn-sm btn-outline-primary">View</a>
                                    <a href="{% url 'edit_risk' risk.id %}" class="btn btn-sm btn-outline-secondary">Edit</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center">No risks found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if all_risks_page.has_other_pages %}
                <nav aria-label="Risks pagination">
                    <ul class="pagination justify-content-center">
                        {% if all_risks_page.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1" aria-label="First">
                                    <span aria-hidden="true">&laquo;&laquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ all_risks_page.previous_page_number }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        {% endif %}
                        
                        {% for num in all_risks_page.paginator.page_range %}
                            {% if all_risks_page.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > all_risks_page.number|add:'-3' and num < all_risks_page.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if all_risks_page.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ all_risks_page.next_page_number }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ all_risks_page.paginator.num_pages }}" aria-label="Last">
                                    <span aria-hidden="true">&raquo;&raquo;</span>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <small class="text-muted">
                        Showing {{ all_risks_page.start_index }} to {{ all_risks_page.end_index }} of {{ all_risks_page.paginator.count }} risks
                    </small>
                    <small class="text-muted">
                        Page {{ all_risks_page.number }} of {{ all_risks_page.paginator.num_pages }}
                    </small>
                </div>
                {% endif %}
                
                <div class="text-center py-4" id="noRisksMessage" style="display: none;">
                    <p>No risks match your current filters.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Store data in script tags using Django's json_script -->
{{ severity_data|json_script:"severity-data" }}
{{ category_data|json_script:"category-data" }}
{{ status_data|json_script:"status-data" }}
{{ risk_matrix_data|json_script:"risk-matrix-data" }}

<!-- Include Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.1.1/dist/chartjs-chart-matrix.min.js"></script>
<script>
    // Retrieve data from script tags
    const severityData = JSON.parse(document.getElementById('severity-data').textContent);
    const categoryData = JSON.parse(document.getElementById('category-data').textContent);
      // Retrieve status data from json_script tag
    const statusData = JSON.parse(document.getElementById('status-data').textContent);
      // Retrieve risk matrix data from backend
    const riskMatrixData = JSON.parse(document.getElementById('risk-matrix-data').textContent);
      // Debug: Log the risk matrix data to console
    console.log('Risk Matrix Data from backend:', riskMatrixData);
      // Debug: Show the complete data structure with indices
    console.log('Complete risk matrix data structure:');
    riskMatrixData.forEach((entry, index) => {
        console.log(`Index ${index}: x=${entry.x}, y=${entry.y}, score=${entry.v}, count=${entry.count}`);
        if (entry.v === 6) {
            console.log(`  ^^^ This is a SCORE 6 entry at index ${index}`);
        }
    });
      // Debug: Log score 6 entries specifically
    const score6Entries = riskMatrixData.filter(entry => entry.v === 6);
    console.log('Score 6 entries:', score6Entries);
      // Debug: Calculate total risks with score 6
    const totalScore6Risks = score6Entries.reduce((sum, entry) => sum + entry.count, 0);
    console.log('Total risks with score 6:', totalScore6Risks);
    
    // Debug: Log each score 6 entry in detail
    score6Entries.forEach((entry, index) => {
        console.log(`Score 6 entry ${index + 1}:`, {
            position: `(${entry.x}, ${entry.y})`,
            likelihood: entry.x + 1,
            impact: entry.y + 1,
            score: entry.v,
            count: entry.count
        });
    });
    
    let severityChart, categoryChart, statusChart, heatMapChart;
    
    // Initialize charts when the document is ready
    document.addEventListener('DOMContentLoaded', function() {
        initCharts();
        setupFilters();
        setupSearch();
    });
    
    function initCharts() {
        // Risk Severity Chart
        const severityCtx = document.getElementById('riskSeverityChart').getContext('2d');
        severityChart = new Chart(severityCtx, {
            type: 'pie',
            data: {
                labels: ['High', 'Medium', 'Low'],
                datasets: [{
                    data: [
                        severityData.high,
                        severityData.medium,
                        severityData.low
                    ],
                    backgroundColor: ['#dc3545', '#ffc107', '#28a745'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total ? Math.round((value / total) * 100) : 0;
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        // Risk Category Chart
        const categoryCtx = document.getElementById('riskCategoryChart').getContext('2d');
        categoryChart = new Chart(categoryCtx, {
            type: 'bar',
            data: {
                labels: categoryData.labels,
                datasets: [{
                    label: 'Number of Risks',
                    data: categoryData.values,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.raw || 0;
                                return `${label}: ${value}`;
                            }
                        }
                    }
                }
            }
        });
        
        // Risk Status Chart
        const statusCtx = document.getElementById('riskStatusChart').getContext('2d');
        statusChart = new Chart(statusCtx, {
            type: 'pie',
            data: {
                labels: statusData.labels,
                datasets: [{
                    data: statusData.values,
                    backgroundColor: ['#ffc107', '#17a2b8', '#28a745'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    }
                }
            }
        });        // Risk Heat Map - Simple bar chart approach
        const heatMapCtx = document.getElementById('riskHeatMap').getContext('2d');
        
        // Create labels and data for each risk score combination
        const heatMapLabels = [];
        const heatMapCounts = [];
        const heatMapColors = [];
        
        // Process risk matrix data to create bar chart
        riskMatrixData.forEach((entry, index) => {
            if (entry.count > 0) {  // Only show cells with risks
                const likelihoodLabels = ['Low', 'Medium', 'High'];
                const impactLabels = ['Low', 'Medium', 'High'];
                const label = `${likelihoodLabels[entry.x]} Likelihood × ${impactLabels[entry.y]} Impact (Score ${entry.v})`;
                
                heatMapLabels.push(label);
                heatMapCounts.push(entry.count);
                
                // Color based on risk score
                if (entry.v >= 6) {
                    heatMapColors.push('rgba(220, 53, 69, 0.8)'); // Red for high risk
                } else if (entry.v >= 3) {
                    heatMapColors.push('rgba(255, 193, 7, 0.8)'); // Yellow for medium risk
                } else {
                    heatMapColors.push('rgba(40, 167, 69, 0.8)'); // Green for low risk
                }
            }
        });
        
        console.log('Heat map labels:', heatMapLabels);
        console.log('Heat map counts:', heatMapCounts);
        
        heatMapChart = new Chart(heatMapCtx, {
            type: 'bar',
            data: {
                labels: heatMapLabels,
                datasets: [{
                    label: 'Number of Risks',
                    data: heatMapCounts,
                    backgroundColor: heatMapColors,
                    borderColor: heatMapColors.map(color => color.replace('0.8', '1')),
                    borderWidth: 1
                }]
            },            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Risk Distribution by Likelihood × Impact'
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return context[0].label; // Show the full category name as title
                            },
                            label: function(context) {
                                const value = context.parsed.y || 0;
                                console.log('Bar chart tooltip - Label:', context.label, 'Value:', value);
                                return `Number of Risks: ${value}`;
                            },
                            afterLabel: function(context) {
                                // Extract score from label for additional info
                                const label = context.label;
                                const scoreMatch = label.match(/Score (\d+)/);
                                if (scoreMatch) {
                                    const score = scoreMatch[1];
                                    if (score >= 6) {
                                        return 'Risk Level: High';
                                    } else if (score >= 3) {
                                        return 'Risk Level: Medium';
                                    } else {
                                        return 'Risk Level: Low';
                                    }
                                }
                                return '';
                            }
                        }
                    },
                    legend: {
                        display: false // Hide legend since colors are self-explanatory
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        },
                        title: {
                            display: true,
                            text: 'Number of Risks'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Risk Categories (hover for details)'
                        },
                        ticks: {
                            display: false // Hide individual bar labels
                        },
                        grid: {
                            display: false // Clean up the appearance
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    }
    
    function setupFilters() {
        const applyFilters = document.getElementById('applyFilters');
        const resetFilters = document.getElementById('resetFilters');
        
        applyFilters.addEventListener('click', function() {
            applyTableFilters();
        });
        
        resetFilters.addEventListener('click', function() {
            document.getElementById('projectFilter').value = 'all';
            document.getElementById('riskLevelFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('riskSearchInput').value = '';
            applyTableFilters();
        });
    }
    
    function setupSearch() {
        const searchInput = document.getElementById('riskSearchInput');
        
        searchInput.addEventListener('keyup', function() {
            applyTableFilters();
        });
    }
    
    function applyTableFilters() {
        const projectFilter = document.getElementById('projectFilter').value;
        const riskLevelFilter = document.getElementById('riskLevelFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const categoryFilter = document.getElementById('categoryFilter').value;
        const searchText = document.getElementById('riskSearchInput').value.toLowerCase();
        
        const rows = document.querySelectorAll('#allRisksTable tbody tr');
        let visibleCount = 0;
        
        rows.forEach(function(row) {
            const projectMatch = projectFilter === 'all' || row.dataset.project === projectFilter;
            const levelMatch = riskLevelFilter === 'all' || row.dataset.level === riskLevelFilter;
            const statusMatch = statusFilter === 'all' || row.dataset.status === statusFilter;
            const categoryMatch = categoryFilter === 'all' || row.dataset.category === categoryFilter;
            
            // Text search
            const riskText = row.innerText.toLowerCase();
            const textMatch = searchText === '' || riskText.includes(searchText);
            
            // Combine all filters
            const showRow = projectMatch && levelMatch && statusMatch && categoryMatch && textMatch;
            
            row.style.display = showRow ? '' : 'none';
            
            if (showRow) {
                visibleCount++;
            }
        });
          // Show/hide "no risks" message
        document.getElementById('noRisksMessage').style.display = visibleCount > 0 ? 'none' : 'block';
        
        // TODO: If backend API available, could update charts based on filters
    }
    
    function clearFilters() {
        document.getElementById('projectFilter').value = 'all';
        document.getElementById('riskLevelFilter').value = 'all';
        document.getElementById('statusFilter').value = 'all';
        document.getElementById('categoryFilter').value = 'all';
        document.getElementById('riskSearchInput').value = '';
        applyTableFilters();
    }
</script>
{% endblock %}